generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id                     String                 @id @default(uuid())
  providerId             String
  externalId             String
  name                   String
  category               String
  subcategory            String?
  activityTypeId         String?
  activitySubtypeId      String?
  description            String?
  schedule               String?
  dates                  String?
  dateStart              DateTime?
  dateEnd                DateTime?
  registrationDate       DateTime?
  registrationEndDate    DateTime?
  registrationEndTime    String?
  ageMin                 Int?
  ageMax                 Int?
  cost                   Float                  @default(0)
  costIncludesTax        Boolean                @default(true)
  taxAmount              Float?
  spotsAvailable         Int?
  totalSpots             Int?
  locationId             String?
  locationName           String?
  registrationUrl        String?
  courseId               String?
  isActive               Boolean                @default(true)
  lastSeenAt             DateTime               @default(now())
  rawData                Json?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @default(now()) @updatedAt
  dayOfWeek              String[]
  startTime              String?
  endTime                String?
  registrationStatus     String?                @default("Unknown")
  registrationButtonText String?
  detailUrl              String?
  fullDescription        String?
  instructor             String?
  prerequisites          String?
  whatToBring            String?
  fullAddress            String?
  latitude               Float?
  longitude              Float?
  directRegistrationUrl  String?
  contactInfo            String?
  courseDetails          String?
  hasMultipleSessions    Boolean                @default(false)
  sessionCount           Int                    @default(0)
  hasPrerequisites       Boolean                @default(false)
  isUpdated              Boolean?               @default(false)

  // Featured partner fields (admin-only)
  isFeatured             Boolean                @default(false)
  featuredTier           String?                // 'gold', 'silver', 'bronze'
  featuredStartDate      DateTime?
  featuredEndDate        DateTime?

  // Vendor import tracking
  vendorId               String?
  importBatchId          String?
  importedAt             DateTime?
  lastImportedAt         DateTime?

  // Manual edit protection - prevents scrapers from overwriting admin edits
  manuallyEditedFields   String[]               @default([])  // Field names that were manually edited
  manuallyEditedAt       DateTime?                            // When last manually edited
  manuallyEditedBy       String?                              // Admin who made the edit

  activitySubtype        ActivitySubtype?       @relation(fields: [activitySubtypeId], references: [id])
  activityType           ActivityType?          @relation(fields: [activityTypeId], references: [id])
  location               Location?              @relation(fields: [locationId], references: [id])
  provider               Provider               @relation(fields: [providerId], references: [id])
  prerequisitesList      ActivityPrerequisite[]
  sessions               ActivitySession[]
  childActivities        ChildActivity[]
  favorites              Favorite[]
  vendor                 Vendor?                @relation("VendorActivities", fields: [vendorId], references: [id])
  importRows             ImportRow[]

  @@unique([providerId, externalId])
  @@index([vendorId])
  @@index([vendorId, externalId])
  @@index([activitySubtypeId])
  @@index([activityTypeId, activitySubtypeId])
  @@index([activityTypeId])
  @@index([category])
  @@index([isActive, category])
  @@index([isActive, dateStart])
  @@index([isActive, lastSeenAt])
  @@index([locationId])
  @@index([providerId])
  @@index([registrationStatus])
  @@index([latitude, longitude])
  @@index([isFeatured, featuredTier])
  @@index([isFeatured, featuredEndDate])
}

model ActivityHistory {
  id            String   @id @default(uuid())
  activityId    String
  changeType    String
  previousData  Json?
  newData       Json?
  changedFields String[]
  createdAt     DateTime @default(now())

  @@index([activityId, createdAt])
}

model ActivityPrerequisite {
  id          String   @id @default(uuid())
  activityId  String
  name        String
  description String?
  url         String?
  courseId    String?
  isRequired  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
}

model ActivitySession {
  id            String   @id @default(uuid())
  activityId    String
  sessionNumber Int?
  date          String?
  dayOfWeek     String?
  startTime     String?
  endTime       String?
  location      String?
  subLocation   String?
  instructor    String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  activity      Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([date])
}

model ActivityShare {
  id               String                 @id @default(uuid())
  sharingUserId    String
  sharedWithUserId String
  permissionLevel  String
  expiresAt        DateTime?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @default(now()) @updatedAt
  sharedWithUser   User                   @relation("SharedWithUser", fields: [sharedWithUserId], references: [id], onDelete: Cascade)
  sharingUser      User                   @relation("SharingUser", fields: [sharingUserId], references: [id], onDelete: Cascade)
  profiles         ActivityShareProfile[]

  @@unique([sharingUserId, sharedWithUserId])
  @@index([sharedWithUserId])
  @@index([sharingUserId])
}

model ActivityShareProfile {
  id                String        @id @default(uuid())
  activityShareId   String
  childId           String
  canViewInterested Boolean       @default(true)
  canViewRegistered Boolean       @default(true)
  canViewCompleted  Boolean       @default(false)
  canViewNotes      Boolean       @default(false)
  createdAt         DateTime      @default(now())
  activityShare     ActivityShare @relation(fields: [activityShareId], references: [id], onDelete: Cascade)
  child             Child         @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([activityShareId, childId])
}

model ActivitySubtype {
  id             String       @id @default(uuid())
  activityTypeId String
  code           String
  name           String
  description    String?
  imageUrl       String?
  displayOrder   Int          @default(999)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  activities     Activity[]
  activityType   ActivityType @relation(fields: [activityTypeId], references: [id], onDelete: Cascade)

  @@unique([activityTypeId, code])
  @@index([activityTypeId])
}

model ActivityType {
  id           String            @id @default(uuid())
  code         String            @unique
  name         String
  description  String?
  iconName     String?
  imageUrl     String?
  displayOrder Int
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt
  activities   Activity[]
  subtypes     ActivitySubtype[]

  @@index([code])
}

model Child {
  id              String                 @id @default(uuid())
  userId          String
  name            String
  dateOfBirth     DateTime
  gender          String?
  avatarUrl       String?
  interests       String[]
  notes           String?
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @default(now()) @updatedAt
  profiles        ActivityShareProfile[]
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  childActivities ChildActivity[]

  @@index([userId])
}

model ChildActivity {
  id                String    @id @default(uuid())
  childId           String
  activityId        String
  status            String
  registeredAt      DateTime?
  completedAt       DateTime?
  notes             String?
  rating            Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
  scheduledDate     DateTime? @db.Timestamp(6)
  startTime         String?
  endTime           String?
  recurring         Boolean?  @default(false)
  recurrencePattern String?
  recurrenceEnd     DateTime? @db.Timestamp(6)
  activity          Activity  @relation(fields: [activityId], references: [id])
  child             Child     @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, activityId])
  @@index([activityId])
  @@index([childId, status])
  @@index([scheduledDate])
  @@index([childId, scheduledDate])
}

model Favorite {
  id             String   @id @default(uuid())
  userId         String
  activityId     String
  notifyOnChange Boolean  @default(true)
  createdAt      DateTime @default(now())
  activity       Activity @relation(fields: [activityId], references: [id])
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([activityId])
  @@index([userId])
}

model Invitation {
  id              String    @id @default(uuid())
  senderId        String
  recipientEmail  String
  recipientUserId String?
  status          String
  message         String?
  token           String    @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime  @default(now())
  recipient       User?     @relation("InvitationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)
  sender          User      @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([recipientEmail])
  @@index([senderId])
  @@index([status, expiresAt])
  @@index([token])
}

model City {
  id        String     @id @default(uuid())
  name      String
  province  String
  country   String     @default("Canada")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @default(now()) @updatedAt
  locations Location[]

  @@unique([name, province, country])
  @@index([name])
}

model Location {
  id          String     @id @default(uuid())
  name        String
  address     String     @default("")
  city        String
  province    String
  postalCode  String?
  country     String     @default("Canada")
  latitude    Float?
  longitude   Float?
  facility    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt
  cityId      String?
  fullAddress String?
  mapUrl      String?
  placeId     String?
  phoneNumber String?
  website     String?
  activities  Activity[]
  cityRecord  City?      @relation(fields: [cityId], references: [id], onDelete: Restrict)

  @@index([cityId])
  @@index([name])
  @@index([name, cityId])
}

model Provider {
  id                 String               @id @default(uuid())
  name               String               @unique
  website            String
  platform           String?
  region             String?
  contactInfo        Json?
  scraperConfig      Json
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now()) @updatedAt
  activities         Activity[]
  ProviderMetrics    ProviderMetrics[]
  ScrapeJob          ScrapeJob[]
  ScraperHealthCheck ScraperHealthCheck[]
  vendor             Vendor?
  partnerAccount     PartnerAccount?

  @@index([isActive])
  @@index([platform])
  @@index([region])
}

model ProviderMetrics {
  id                  String   @id @default(uuid())
  providerId          String
  scrapeDate          DateTime @db.Date
  activitiesFound     Int      @default(0)
  activitiesProcessed Int      @default(0)
  dataQualityScore    Float?
  errors              Json?
  scrapeDuration      Int?
  memoryUsed          BigInt?
  createdAt           DateTime @default(now())
  provider            Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([providerId, scrapeDate])
  @@index([scrapeDate])
}

model ScrapeJob {
  id                String    @id @default(uuid())
  providerId        String
  status            JobStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  activitiesFound   Int       @default(0)
  activitiesCreated Int       @default(0)
  activitiesUpdated Int       @default(0)
  activitiesRemoved Int       @default(0)
  errorMessage      String?
  errorDetails      Json?
  createdAt         DateTime  @default(now())
  provider          Provider  @relation(fields: [providerId], references: [id])

  @@index([createdAt])
  @@index([providerId])
  @@index([status])
}

model ScraperHealthCheck {
  id         String    @id @default(uuid())
  providerId String
  status     String
  message    String?
  details    Json?
  checkedAt  DateTime  @default(now())
  resolvedAt DateTime?
  provider   Provider  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([checkedAt])
  @@index([providerId])
  @@index([status])
}

model ScraperRun {
  id                    String    @id @default(uuid())
  providerId            String
  status                String
  startedAt             DateTime  @default(now())
  completedAt           DateTime?
  activitiesFound       Int       @default(0)
  activitiesCreated     Int       @default(0)
  activitiesUpdated     Int       @default(0)
  activitiesDeactivated Int       @default(0)
  activitiesPurged      Int       @default(0)
  errorMessage          String?
  logs                  Json?

  // Field coverage metrics
  fieldCoverage         Json?     // { name: 100, externalId: 98, ... }
  avgFieldCoverage      Float?    // Overall average (e.g., 94.5)

  // Alert tracking
  alertSent             Boolean   @default(false)
  alertReason           String?   // "activity_count_change" | "coverage_drop" | null

  @@index([providerId, startedAt])
  @@index([alertSent, startedAt])
}

model User {
  id                  String          @id @default(uuid())
  email               String          @unique
  passwordHash        String
  name                String
  phoneNumber         String?
  isVerified          Boolean         @default(false)
  verificationToken   String?
  resetToken          String?
  resetTokenExpiry    DateTime?
  preferences         Json            @default("{}")
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now()) @updatedAt
  sharedWithMe        ActivityShare[] @relation("SharedWithUser")
  myShares            ActivityShare[] @relation("SharingUser")
  children            Child[]
  favorites           Favorite[]
  receivedInvitations Invitation[]    @relation("InvitationRecipient")
  sentInvitations     Invitation[]    @relation("InvitationSender")
  sessions            Session[]
  trustedDevices      TrustedDevice[]
  subscription        Subscription?
  savedSearches       SavedSearch[]

  // Third-party import system
  adminProfile        AdminUser?
  vendorMemberships   VendorUser[]
  importBatches       ImportBatch[]

  @@index([email])
}

model Session {
  id               String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId           String
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?
  ipAddress        String?   @db.VarChar(45)
  createdAt        DateTime? @default(now())
  expiresAt        DateTime
  lastAccessedAt   DateTime? @default(now())
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
}

model TrustedDevice {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId      String
  fingerprint String    @db.VarChar(255)
  name        String?   @default("Unknown Device") @db.VarChar(255)
  createdAt   DateTime? @default(now())
  expiresAt   DateTime
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([expiresAt])
}

model AgeGroup {
  id           String   @id @default(uuid())
  code         String   @unique
  label        String
  minAge       Int
  maxAge       Int
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([displayOrder])
  @@index([isActive])
}

// ============================================
// SUBSCRIPTION MODELS (Freemium Monetization)
// ============================================

model SubscriptionPlan {
  id                 String         @id @default(uuid())
  code               String         @unique // 'free', 'premium'
  name               String
  description        String?
  monthlyPrice       Float          @default(0)
  annualPrice        Float          @default(0)
  maxChildren        Int            @default(2)
  maxFavorites       Int            @default(10)
  maxSharedUsers     Int            @default(1)
  hasAdvancedFilters Boolean        @default(false)
  hasCalendarExport  Boolean        @default(false)
  hasInstantAlerts   Boolean        @default(false)
  hasSavedSearches   Boolean        @default(false)
  savedSearchLimit   Int            @default(0)
  isActive           Boolean        @default(true)
  displayOrder       Int            @default(0)
  subscriptions      Subscription[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([code])
  @@index([isActive])
}

model Subscription {
  id               String           @id @default(uuid())
  userId           String           @unique
  planId           String
  status           String           @default("active") // active, trialing, cancelled, expired
  billingCycle     String?          // monthly, annual (null for free plan)
  startDate        DateTime         @default(now())
  currentPeriodEnd DateTime?
  cancelledAt      DateTime?
  trialEndsAt      DateTime?

  // RevenueCat integration
  externalId       String?          @unique // RevenueCat subscriber ID or Stripe subscription ID
  externalProvider String?          // 'revenuecat', 'stripe'

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             SubscriptionPlan @relation(fields: [planId], references: [id])
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([userId])
  @@index([status])
  @@index([externalId])
  @@index([planId])
}

model SavedSearch {
  id          String    @id @default(uuid())
  userId      String
  name        String
  filters     Json      // Store filter criteria as JSON
  notifyOnNew Boolean   @default(false)
  lastChecked DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum enum_pick_unlock_states_pool_type {
  pickem
  survivor
}

enum enum_pool_invitations_status {
  pending
  sent
  opened
  clicked
  accepted
  declined
  expired
}

enum enum_pool_participants_payment_status {
  not_paid
  partial_paid
  paid_in_full
}

enum enum_squares_payout_config_quarter {
  Q1
  Q2
  Q3
  Q4
  FINAL
}

enum enum_squares_winners_quarter {
  Q1
  Q2
  Q3
  Q4
  FINAL
}

enum enum_users_admin_type {
  none
  pool_admin
  site_admin
}

// ============================================
// THIRD-PARTY IMPORT SYSTEM
// ============================================

// Admin roles for platform administration
enum AdminRole {
  SUPER_ADMIN   // Full system access
  ADMIN         // Can manage vendors, approve imports
  MODERATOR     // Can review and approve imports
  VIEWER        // Read-only access to admin dashboard
}

// Vendor organization status
enum VendorStatus {
  PENDING       // Awaiting verification
  ACTIVE        // Verified and active
  SUSPENDED     // Temporarily suspended
  REJECTED      // Application rejected
  INACTIVE      // Vendor-initiated deactivation
}

// Vendor user roles within organization
enum VendorUserRole {
  OWNER         // Full vendor management
  ADMIN         // Can manage imports, users
  MEMBER        // Can submit imports
}

// Import batch processing status
enum ImportStatus {
  PENDING             // Uploaded, awaiting validation
  VALIDATING          // Validation in progress
  VALIDATION_FAILED   // Validation failed
  VALIDATED           // Validation complete, awaiting processing
  PENDING_APPROVAL    // Submitted for approval
  APPROVED            // Approved, ready to process
  PROCESSING          // Processing in progress
  COMPLETED           // Successfully processed
  PARTIALLY_COMPLETED // Completed with some failures
  FAILED              // Processing failed
  CANCELLED           // Cancelled by user
  REJECTED            // Rejected by admin
  CHANGES_REQUESTED   // Admin requested changes
}

// Approval workflow status
enum ApprovalStatus {
  PENDING           // Awaiting review
  APPROVED          // Approved by admin
  REJECTED          // Rejected by admin
  AUTO_APPROVED     // Automatically approved (trusted vendor)
  CHANGES_REQUESTED // Admin requested changes
}

// Individual import row status
enum ImportRowStatus {
  PENDING   // Awaiting processing
  VALID     // Passed validation
  INVALID   // Failed validation
  CREATED   // Activity created
  UPDATED   // Activity updated
  SKIPPED   // Skipped (duplicate, etc.)
  FAILED    // Processing failed
}

// Admin user profile for platform staff
model AdminUser {
  id              String           @id @default(uuid())
  userId          String           @unique
  role            AdminRole        @default(MODERATOR)
  permissions     Json             @default("[]")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       String?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvalActions ImportApproval[]

  @@index([role])
}

// Third-party vendor organization
model Vendor {
  id                  String         @id @default(uuid())
  code                String         @unique
  name                String
  email               String         @unique
  website             String?
  contactName         String?
  contactPhone        String?
  description         String?
  logoUrl             String?

  // Status & verification
  status              VendorStatus   @default(PENDING)
  verifiedAt          DateTime?
  verifiedBy          String?

  // Approval workflow settings
  requiresApproval    Boolean        @default(true)
  autoApproveUpdates  Boolean        @default(false)

  // Featured partner tier
  defaultFeaturedTier String?
  featuredStartDate   DateTime?
  featuredEndDate     DateTime?

  // Rate limiting
  dailyImportLimit    Int            @default(500)
  monthlyImportLimit  Int            @default(5000)

  // API access
  apiKeyHash          String?
  apiKeyLastUsedAt    DateTime?

  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  providerId          String?        @unique
  provider            Provider?      @relation(fields: [providerId], references: [id])
  imports             ImportBatch[]
  vendorUsers         VendorUser[]
  activities          Activity[]     @relation("VendorActivities")
  fieldMappings       ImportFieldMapping[]

  @@index([status])
  @@index([email])
}

// Vendor portal users (multiple users per vendor)
model VendorUser {
  id         String         @id @default(uuid())
  vendorId   String
  userId     String
  role       VendorUserRole @default(MEMBER)
  invitedBy  String?
  invitedAt  DateTime       @default(now())
  acceptedAt DateTime?
  isActive   Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  vendor     Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([vendorId, userId])
  @@index([userId])
}

// Import batch tracking
model ImportBatch {
  id                    String         @id @default(uuid())
  vendorId              String
  uploadedBy            String

  // File information
  fileName              String
  fileSize              Int
  fileType              String
  fileUrl               String?

  // Processing status
  status                ImportStatus   @default(PENDING)
  totalRows             Int            @default(0)
  validRows             Int            @default(0)
  invalidRows           Int            @default(0)

  // Processing results
  activitiesCreated     Int            @default(0)
  activitiesUpdated     Int            @default(0)
  activitiesSkipped     Int            @default(0)
  activitiesFailed      Int            @default(0)

  // Approval workflow
  requiresApproval        Boolean        @default(true)
  approvalStatus          ApprovalStatus @default(PENDING)
  submittedForApprovalAt  DateTime?
  submittedForApprovalBy  String?
  approvedAt              DateTime?
  approvedBy              String?
  rejectedAt              DateTime?
  rejectedBy              String?
  rejectionReason         String?

  // Timing
  uploadedAt              DateTime       @default(now())
  validationStartedAt     DateTime?
  validationCompletedAt   DateTime?
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?

  // Error tracking
  errors                Json?
  warnings              Json?

  // Metadata
  fieldMappingUsed      Json?
  notes                 String?

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  vendor                Vendor         @relation(fields: [vendorId], references: [id])
  uploadedByUser        User           @relation(fields: [uploadedBy], references: [id])
  rows                  ImportRow[]
  approvals             ImportApproval[]

  @@index([vendorId, status])
  @@index([status])
  @@index([uploadedAt])
}

// Individual row tracking for imports
model ImportRow {
  id                 String          @id @default(uuid())
  importBatchId      String
  rowNumber          Int

  // Raw data
  rawData            Json

  // Parsed data
  parsedData         Json?
  externalId         String?

  // Status
  status             ImportRowStatus @default(PENDING)

  // Linked activity (after successful import)
  activityId         String?
  action             String?

  // Validation
  validationErrors   Json?
  validationWarnings Json?

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  importBatch        ImportBatch     @relation(fields: [importBatchId], references: [id], onDelete: Cascade)
  activity           Activity?       @relation(fields: [activityId], references: [id])

  @@unique([importBatchId, rowNumber])
  @@index([importBatchId, status])
  @@index([externalId])
}

// Approval audit trail
model ImportApproval {
  id            String      @id @default(uuid())
  importBatchId String
  reviewerId    String
  action        String
  reason        String?
  comments      String?
  createdAt     DateTime    @default(now())

  importBatch   ImportBatch @relation(fields: [importBatchId], references: [id], onDelete: Cascade)
  reviewer      AdminUser   @relation(fields: [reviewerId], references: [id])

  @@index([importBatchId])
}

// Field mapping templates
model ImportFieldMapping {
  id              String   @id @default(uuid())
  vendorId        String?
  name            String
  description     String?
  isDefault       Boolean  @default(false)

  // Column mappings
  mappings        Json

  // Transformation rules
  transformations Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vendor          Vendor?  @relation(fields: [vendorId], references: [id])

  @@unique([vendorId, name])
  @@index([vendorId])
}

// ============================================
// CITY REQUEST (Marketing Website)
// ============================================

// City request status
enum CityRequestStatus {
  PENDING    // Awaiting review
  APPROVED   // Will add city
  REJECTED   // Will not add city
  COMPLETED  // City has been added
}

// User requests for new city support
model CityRequest {
  id          String            @id @default(uuid())
  cityName    String
  province    String
  email       String
  sites       String?           // Specific sites/programs requested
  notes       String?
  status      CityRequestStatus @default(PENDING)

  // Admin handling
  reviewedAt  DateTime?
  reviewedBy  String?
  adminNotes  String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

// ============================================
// FEATURED PARTNER MANAGEMENT SYSTEM
// ============================================

// Partner subscription plans (Bronze, Silver, Gold)
model PartnerPlan {
  id              String           @id @default(uuid())
  name            String           // "Bronze", "Silver", "Gold"
  tier            String           // "bronze", "silver", "gold"
  monthlyPrice    Decimal          @db.Decimal(10, 2)
  yearlyPrice     Decimal          @db.Decimal(10, 2)
  impressionLimit Int?             // null = unlimited
  features        Json             // Feature flags for this tier
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  accounts        PartnerAccount[]

  @@map("SponsorPlan")
  @@index([tier])
  @@index([isActive])
}

// Partner accounts (businesses that are featured partners)
model PartnerAccount {
  id                    String                    @id @default(uuid())
  providerId            String                    @unique
  provider              Provider                  @relation(fields: [providerId], references: [id])
  planId                String?
  plan                  PartnerPlan?              @relation(fields: [planId], references: [id])

  // RevenueCat integration
  revenueCatCustomerId  String?
  subscriptionStatus    String                    @default("inactive") // active, cancelled, past_due, inactive
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?

  // Geographic targeting
  targetCities          String[]                  // City IDs for targeting
  targetProvinces       String[]                  // Province codes

  // Contact info
  billingEmail          String
  billingName           String?

  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  impressions           PartnerImpression[]
  clicks                PartnerClick[]
  abTestAssignments     PartnerABTestAssignment[]

  @@map("SponsorAccount")
  @@index([subscriptionStatus])
  @@index([providerId])
}

// Impression tracking (batch inserts for performance)
model PartnerImpression {
  id               String         @id @default(uuid())
  partnerAccountId String
  partnerAccount   PartnerAccount @relation(fields: [partnerAccountId], references: [id])
  activityId       String?

  // Context
  placement        String         // "activity_list", "activity_detail", "search_results", "dashboard"
  userId           String?        // Anonymous if null
  city             String?
  province         String?

  // A/B test info
  abTestId         String?
  abVariant        String?

  // Device info
  platform         String         // "ios", "android", "web"
  deviceType       String?        // "phone", "tablet"

  timestamp        DateTime       @default(now())

  @@map("SponsorImpression")
  @@index([partnerAccountId])
  @@index([activityId])
  @@index([timestamp])
  @@index([placement])
  @@index([city])
}

// Click tracking
model PartnerClick {
  id               String         @id @default(uuid())
  partnerAccountId String
  partnerAccount   PartnerAccount @relation(fields: [partnerAccountId], references: [id])
  activityId       String?

  // Context
  placement        String
  destinationType  String         // "activity_detail", "external_url", "registration"
  destinationUrl   String?

  userId           String?
  city             String?
  province         String?

  // A/B test info
  abTestId         String?
  abVariant        String?

  platform         String
  timestamp        DateTime       @default(now())

  @@map("SponsorClick")
  @@index([partnerAccountId])
  @@index([activityId])
  @@index([timestamp])
}

// A/B test status enum
enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}

// A/B Tests for partner placement optimization
model PartnerABTest {
  id                      String                    @id @default(uuid())
  name                    String
  description             String?

  // Test configuration
  testType                String                    // "placement", "display_style", "frequency"
  variants                Json                      // Array of variant configurations

  // Traffic allocation
  trafficPercent          Int                       @default(100) // Percentage of users in test

  // Status
  status                  ABTestStatus              @default(DRAFT)
  startDate               DateTime?
  endDate                 DateTime?

  // Results
  winningVariant          String?
  statisticalSignificance Decimal?                  @db.Decimal(5, 4)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  createdBy               String?

  assignments             PartnerABTestAssignment[]

  @@map("SponsorABTest")
  @@index([status])
  @@index([testType])
}

// User assignments to A/B test variants
model PartnerABTestAssignment {
  id               String          @id @default(uuid())
  testId           String
  test             PartnerABTest   @relation(fields: [testId], references: [id])

  // Can be user ID or device ID for anonymous users
  identifier       String
  identifierType   String          // "user_id", "device_id"
  variant          String

  partnerAccountId String?
  partnerAccount   PartnerAccount? @relation(fields: [partnerAccountId], references: [id])

  assignedAt       DateTime        @default(now())

  @@map("SponsorABTestAssignment")
  @@unique([testId, identifier])
  @@index([testId])
  @@index([identifier])
}

// Daily aggregated analytics (for fast dashboard queries)
model PartnerAnalyticsDaily {
  id                        String   @id @default(uuid())
  partnerAccountId          String
  date                      DateTime @db.Date

  // Impression counts by placement
  impressionsTotal          Int      @default(0)
  impressionsActivityList   Int      @default(0)
  impressionsActivityDetail Int      @default(0)
  impressionsSearchResults  Int      @default(0)
  impressionsDashboard      Int      @default(0)

  // Click counts
  clicksTotal               Int      @default(0)
  clicksActivityDetail      Int      @default(0)
  clicksExternalUrl         Int      @default(0)
  clicksRegistration        Int      @default(0)

  // Calculated metrics
  ctr                       Decimal? @db.Decimal(5, 4) // Click-through rate

  // Geographic breakdown (JSON for flexibility)
  impressionsByCity         Json?
  clicksByCity              Json?

  // Platform breakdown
  impressionsByPlatform     Json?
  clicksByPlatform          Json?

  @@map("SponsorAnalyticsDaily")
  @@unique([partnerAccountId, date])
  @@index([partnerAccountId])
  @@index([date])
}
